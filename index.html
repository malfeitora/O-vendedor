<script>
    const items = [/*... seus itens ...*/];

    const frasesDuque = [
        "O DUQUE está negociando seus itens, aguarde.",
        "O DUQUE partiu rumo ao Reino da Névoa Eterna.",
        "O DUQUE está indo para as Terras Proibidas.",
        "O DUQUE foi visto nas margens da Árvore-Mãe.",
        "O DUQUE está dormindo sob as cinzas de um antigo dragão."
    ];

    function formatarHora(h, m) {
        return h.toString().padStart(2, '0') + ":" + m.toString().padStart(2, '0');
    }

    function escolherItensAleatorios(quantidade) {
        let escolhidos = [];
        let usados = new Set();
        while (escolhidos.length < quantidade) {
            let i = Math.floor(Math.random() * items.length);
            if (!usados.has(i)) {
                escolhidos.push(items[i]);
                usados.add(i);
            }
        }
        return escolhidos;
    }

    function mostrarLoja(horaInicio, minutoInicio, horaFim, minutoFim) {
        const storeDiv = document.getElementById("store");
        const loadingDiv = document.getElementById("loading");
        const horarioDiv = document.getElementById("horario");

        storeDiv.innerHTML = "";
        loadingDiv.innerHTML = "";
        horarioDiv.innerHTML = `LOJA ABERTA entre <strong>${formatarHora(horaInicio, minutoInicio)}</strong> e <strong>${formatarHora(horaFim, minutoFim)}</strong>`;

        const itensHoje = escolherItensAleatorios(5);
        itensHoje.forEach(item => {
            const itemDiv = document.createElement("div");
            itemDiv.classList.add("item");
            itemDiv.innerHTML = `<img src="imagens/${item}" alt="${item}">`;
            storeDiv.appendChild(itemDiv);
        });

        // Timer de contagem regressiva de 23 minutos para fechamento
        const timerDiv = document.getElementById("timer");
        let tempoRestante = 23 * 60; // 23 minutos em segundos

        const intervalo = setInterval(() => {
            const minutos = Math.floor(tempoRestante / 60);
            const segundos = tempoRestante % 60;
            timerDiv.innerHTML = `Faltam ${minutos}m ${segundos}s para o Duque ir embora.`;

            tempoRestante--;
            if (tempoRestante <= 0) {
                clearInterval(intervalo);
                timerDiv.innerHTML = "O Duque se foi. A loja está fechada.";
            }
        }, 1000);
    }

    function mostrarFechada(proximaAbertura) {
        const storeDiv = document.getElementById("store");
        const loadingDiv = document.getElementById("loading");
        const horarioDiv = document.getElementById("horario");
        const timerDiv = document.getElementById("timer");

        storeDiv.innerHTML = "";
        horarioDiv.innerHTML = "";

        const frase = frasesDuque[Math.floor(Math.random() * frasesDuque.length)];
        const [h, m] = proximaAbertura.split(":");
        loadingDiv.innerHTML = `${frase}<br><br><strong>O DUQUE retornará às ${formatarHora(h, m)}.</strong>`;

        // Timer para a abertura da loja
        const tempoRestante = (h * 60 + m) - (new Date().getHours() * 60 + new Date().getMinutes());
        const minutosEspera = tempoRestante > 0 ? tempoRestante : (24 * 60 + tempoRestante);

        const intervalo = setInterval(() => {
            const minutos = Math.floor(minutosEspera / 60);
            const segundos = minutosEspera % 60;
            timerDiv.innerHTML = `Faltam ${minutos}m ${segundos}s para a loja abrir.`;

            minutosEspera--;
            if (minutosEspera <= 0) {
                clearInterval(intervalo);
                timerDiv.innerHTML = "A loja está aberta agora!";
            }
        }, 1000);
    }

    // Definir horário aleatório local para abrir
    const agora = new Date();
    const horaAgora = agora.getHours();
    const minutoAgora = agora.getMinutes();

    let horarioAbertura = localStorage.getItem("duque_abre_em");

    if (!horarioAbertura) {
        const horaAleatoria = 8 + Math.floor(Math.random() * 14); // 8h até 21h
        const minutoAleatorio = Math.floor(Math.random() * 60);
        horarioAbertura = `${horaAleatoria}:${minutoAleatorio}`;
        localStorage.setItem("duque_abre_em", horarioAbertura);
    }

    const [horaAbertura, minutoAbertura] = horarioAbertura.split(":").map(Number);
    const minutosAbertura = horaAbertura * 60 + minutoAbertura;
    const minutosAgora = horaAgora * 60 + minutoAgora;
    const duracaoMinutos = 23;
    const minutosFechamento = minutosAbertura + duracaoMinutos;

    const horaFechamento = Math.floor(minutosFechamento / 60);
    const minutoFechamento = minutosFechamento % 60;

    if (minutosAgora >= minutosAbertura && minutosAgora <= minutosFechamento) {
        mostrarLoja(horaAbertura, minutoAbertura, horaFechamento, minutoFechamento);
    } else {
        mostrarFechada(horarioAbertura);
    }
</script>
